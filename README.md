# Анализ задачи по процедуре `sp_report_1`

## Цель

Заказчик утверждает, что в июне 2017 года по группе товаров "Биологически активные добавки":

- Объём продаж: `6761.10` штук  
- Сумма продаж с НДС: `1 782 949.10` рублей

Задача: найти причину расхождения с результатом ETL-процедуры.

---

## Задание 1. Проверка расхождений

Было установлено, что исходная процедура использовала поле `sale_net`, что дало заниженные результаты.  
После замены на `sale_grs` и корректной фильтрации — результат совпал с цифрами заказчика.

Также в процессе анализа были выявлены проблемы с качеством данных в справочниках (`dim_goods`, `dim_cash_register`, `dim_stores`) — часть ID была задвоена, часть отсутствовала. После их устранения можно вернуться к корректным `JOIN`-запросам.

---

## Финальный запрос (после очистки справочников)

```sql
SELECT 
    SUM(f.sale_grs) AS [Продажи руб., с НДС],
    SUM(f.quantity) AS [Объём продаж, шт.]
FROM fct_cheque f
JOIN dim_goods g ON f.good_id = g.good_id
JOIN dim_date d ON f.date_id = d.did
JOIN dim_stores s ON f.store_id = s.store_id
JOIN dim_cash_register cr ON f.cash_register_id = cr.cash_register_id
WHERE CAST(d.d AS DATE) BETWEEN '2017-06-01' AND '2017-06-30'
  AND g.group_name = N'Биологически активные добавки';
```

---

## Проблемы качества данных

- В `dim_goods` найдены дубликаты по `good_id`: `245427`, `102018`, `1553`
- В `dim_cash_register` дубликат по `cash_register_id = 7`
- В `dim_stores` отсутствовал `store_id = 47`, хотя он использовался в `fct_cheque`
- Некоторые строки из фактов не находили соответствий в справочниках при `JOIN`

> См. файл [`sql/data_fix.sql`](sql/data_fix.sql) для исправлений.

---

## Структура проекта

- `sql/01_check_discrepancy.sql` — проверка расхождений (Задание 1)
- `sql/data_fix.sql` — очистка справочников

---

## План на будущее

Следующим шагом будет добавление:
- средней закупочной цены
- расчёта маржи
- наценки %

Эти шаги будут оформлены в отдельных `.sql` файлах по мере выполнения.
