# Тестовое задание

## Задача 1

Заказчик утверждает, что в июне 2017 года по группе товаров "Биологически активные добавки":

- Объём продаж: `6761.10` штук  
- Сумма продаж с НДС: `1 782 949.10` рублей

Задача: найти причину расхождения с результатом ETL-процедуры.

---

## Проверка расхождений

Было установлено, что исходная процедура использовала поле `sale_net`, что дало заниженные результаты.  
После замены на `sale_grs` и корректной фильтрации — результат совпал с цифрами заказчика.

Также в процессе анализа были выявлены проблемы с качеством данных в справочниках (`dim_goods`, `dim_cash_register`, `dim_stores`) — часть ID была задвоена, часть отсутствовала. После их устранения можно вернуться к корректным `JOIN`-запросам.

---

## Финальный запрос (после очистки справочников)

```sql
SELECT 
    SUM(f.sale_grs) AS [Продажи руб., с НДС],
    SUM(f.quantity) AS [Объём продаж, шт.]
FROM fct_cheque f
JOIN dim_goods g ON f.good_id = g.good_id
JOIN dim_date d ON f.date_id = d.did
JOIN dim_stores s ON f.store_id = s.store_id
JOIN dim_cash_register cr ON f.cash_register_id = cr.cash_register_id
WHERE CAST(d.d AS DATE) BETWEEN '2017-06-01' AND '2017-06-30'
  AND g.group_name = N'Биологически активные добавки';
```

---

## Проблемы качества данных

- В `dim_goods` найдены дубликаты по `good_id`: `245427`, `102018`, `1553`
- В `dim_cash_register` дубликат по `cash_register_id = 7`
- В `dim_stores` отсутствовал `store_id = 47`, хотя он использовался в `fct_cheque`
- Некоторые строки из фактов не находили соответствий в справочниках при `JOIN`

> См. файл [`data_fix.sql`](data_fix.sql) для исправления данных, а исправленная процедура — в [`01_check_discrepancy.sql`](01_check_discrepancy.sql).

---

## Задача 2

Необходимо добавить показатели:
- Средняя цена закупки руб., без НДС
- Маржа руб. без НДС
- Наценка % без НДС

---

## Как рассчитываются показатели

- **Средняя цена закупки (без НДС)**  
  Вычисляется как взвешенное среднее:  
  `SUM(cost_net) / SUM(quantity)`

- **Маржа, руб. (без НДС)**  
  Разница между продажей и закупкой:  
  `SUM(sale_net) - SUM(cost_net)`

- **Наценка, % (без НДС)**  
  Показывает, на сколько процентов продажа выше закупки:  
  `(Маржа / SUM(cost_net)) * 100`


> См. файл [`02_avg_cost_margin_markup.sql`](02_avg_cost_margin_markup.sql) с кодом процедуры.

---

## Задание 3

Добавить возможность фильтрации по нескольким группам товаров одновременно.  
На вход группы подаются через запятую в параметр `@good_group_name`.

---

## Реализация

Для поддержки фильтрации по нескольким группам строка `@good_group_name` разбивается с помощью функции `STRING_SPLIT`:

```sql
AND g.group_name IN (
    SELECT TRIM(value)
    FROM STRING_SPLIT(@good_group_name, ',')
)
```

Это позволяет передавать список групп в виде строки через запятую (например, 'БАДы,Косметика') и корректно фильтровать товары по каждой из них.

Использование TRIM(value) обеспечивает надёжную обработку пробелов в названиях.

> См. файл [`03_multi_group_filter.sql`](03_multi_group_filter.sql) с кодом процедуры.

---

## Задание 4

Вывести долю продаж с НДС товара, в каждом дне/магазине/группе товаров, и отсортировать выборку по убыванию показателя.

---

### Реализация

Для решения задачи используется два CTE (`WITH`):

#### 1. `sales_cte` — расчёт продаж по каждой позиции

```sql
WITH sales_cte AS (
  SELECT 
    d.d AS [Дата],
    s.store_name AS [Аптека],
    g.group_name AS [Группа товара],
    g.good_name AS [Номенклатура],
    SUM(f.sale_grs) AS [Продажи руб., с НДС]
  FROM ...
  GROUP BY d.d, s.store_name, g.group_name, g.good_name
)
```

#### 2. `summary_cte` — расчёт суммарных продаж группы

```sql
summary_cte AS (
  SELECT 
    [Дата],
    [Аптека],
    [Группа товара],
    SUM([Продажи руб., с НДС]) AS [Итого продаж, руб., с НДС]
  FROM sales_cte
  GROUP BY [Дата], [Аптека], [Группа товара]
)
```

#### 3. Основной запрос — расчёт доли

```sql
SELECT 
  s.[Дата],
  s.[Аптека],
  s.[Группа товара],
  s.[Номенклатура],
  s.[Продажи руб., с НДС],
  ROUND(s.[Продажи руб., с НДС] / NULLIF(sum_cte.[Итого продаж, руб., с НДС], 0) * 100, 2) AS [Доля продаж, %]
FROM sales_cte s
JOIN summary_cte sum_cte 
  ON s.[Дата] = sum_cte.[Дата]
  AND s.[Аптека] = sum_cte.[Аптека]
  AND s.[Группа товара] = sum_cte.[Группа товара]
ORDER BY [Доля продаж, %] DESC;
```

---

### Используемые поля

| Поле         | Источник     | Значение                              |
|--------------|--------------|---------------------------------------|
| `sale_grs`   | `fct_cheque` | Сумма продажи с НДС                   |
| `good_name`  | `dim_goods`  | Наименование конкретного товара       |
| `group_name` | `dim_goods`  | Название товарной группы              |
| `store_name` | `dim_stores` | Аптека                                |
| `d` (дата)   | `dim_date`   | Дата продажи                          |

---
> См. файл [`04_sales_share_by_group.sql`](04_sales_share_by_group.sql) с кодом процедуры.
